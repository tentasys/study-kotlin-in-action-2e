# ğŸ“š 15ì¥ êµ¬ì¡°í™”ëœ ë™ì‹œì„±

## ğŸ“– 15.1 ì½”ë£¨í‹´ ìŠ¤ì½”í”„ê°€ ì½”ë£¨í‹´ ê°„ì˜ êµ¬ì¡°ë¥¼ í™•ë¦½í•œë‹¤

- êµ¬ì¡°í™”ëœ ë™ì‹œì„±ì„ í†µí•´ ê° ì½”ë£¨í‹´ì€ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ì— ì†í•˜ê²Œ ëœë‹¤.
- ë‹¤ë¥¸ ì½”ë£¨í‹´ ë¹Œë”ì˜ ë³¸ë¬¸ì—ì„œ `launch`ë‚˜ `async`ë¥¼ ì‚¬ìš©í•´ ìƒˆë¡œìš´ ì½”ë£¨í‹´ì„ ë§Œë“¤ë©´ ì´ ìƒˆë¡œìš´ ì½”ë£¨í‹´ì€ ìë™ìœ¼ë¡œ í•´ë‹¹ ì½”ë£¨í‹´ì˜ ìì‹ì´ ëœë‹¤.

```kotlin
fun main() {
    runBlocking {
        launch {
            delay(1.seconds)
            launch {
                delay(250.milliseconds)
                log("Grandchild done")
            }
            log("Child 1 done!")
        }
        launch {
            delay(500.milliseconds)
            log("Child 2 done!")
        }
        log("Parent done!")
    }
}
```

```text
0 [main @coroutine#1] Parent done!
524 [main @coroutine#3] Child 2 done!
1020 [main @coroutine#2] Child 1 done!
1275 [main @coroutine#4] Grandchild done
```

- ëª¨ë“  ìì‹ ì½”ë£¨í‹´ì´ ì™„ë£Œë  ë•Œê¹Œì§€ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë˜ì§€ ì•ŠëŠ”ë‹¤.

### ğŸ”– 15.1.1 ì½”ë£¨í‹´ ìŠ¤ì½”í”„ ìƒì„±: coroutineScope í•¨ìˆ˜

- ì½”ë£¨í‹´ ë¹Œë”ë¥¼ ì‚¬ìš©í•´ ìƒˆë¡œìš´ ì½”ë£¨í‹´ì„ ë§Œë“¤ë©´ ì´ ì½”ë£¨í‹´ì€ ìì²´ì ì¸ `CoroutineScope`ë¥¼ ìƒì„±í•œë‹¤.
- `CoroutineScope` í•¨ìˆ˜ì˜ ì „í˜•ì ì¸ ì‚¬ìš© ì‚¬ë¡€ëŠ” ë™ì‹œì  ì‘ì—… ë¶„í•´(ì—¬ëŸ¬ ì½”ë£¨í‹´ì„ í™œìš©í•´ ê³„ì‚° ìˆ˜í–‰)

```kotlin
suspend fun generateValue(): Int {
    delay(500.milliseconds)
    return Random.nextInt(0, 10)
}

suspend fun computeSum() {
    log("Computing a sum...")
    val sum = coroutineScope {
        val a = async { generateValue() }
        val b = async { generateValue() }
        a.await() + b.await()
    }
    log("Sum is $sum")
}
```

### ğŸ”– 15.1.2 ì½”ë£¨í‹´ ìŠ¤ì½”í”„ë¥¼ ì»´í¬ë„ŒíŠ¸ì™€ ì—°ê´€ì‹œí‚¤ê¸°: CoroutineScope

- `coroutineScope` í•¨ìˆ˜ê°€ ì‘ì—…ì„ ë¶„í•´í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë°˜ë©´ êµ¬ì²´ì  ìƒëª…ì£¼ê¸°ë¥¼ ì •ì˜í•˜ê³ , ë™ì‹œ ì²˜ë¦¬ë‚˜ ì½”ë£¨í‹´ì˜ ì‹œì‘ê³¼ ì¢…ë£Œë¥¼ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ê³  ì‹¶ì„ ëŒ€ë„ ì‡ë‹¤.

```kotlin
class ComponentWithScope(dispatcher: CoroutineDispatcher = Dispatchers.Default) {
    private val scope = CoroutineScope(dispatcher + SupervisorJob())

    fun start() {
        log("Starting")
        scope.launch {
            while (true) {
                delay(500.milliseconds)
                log("Component working!")
            }
        }
        scope.launch {
            log("Doing a one-off task...")
            delay(500.milliseconds)
            log("Task done!")
        }
    }

    fun stop() {
        log("Stopping!")
        scope.cancel()
    }
}
```

- ì´ `Component` í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  `start`ë¥¼ í˜¸ì¶œí•˜ë©´ ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ ì½”ë£¨í‹´ì´ ì‹œì‘ëœë‹¤.

### ğŸ”– 15.1.3 GlobalScopeì˜ ìœ„í—˜ì„±

```kotlin
fun main() = runBlocking {
    GlobalScope.launch {
        delay(1000)
        launch {
            delay(250)
            log("Grandchild done")
        }
        log("Child 1 done!")
    }

    GlobalScope.launch {
        delay(500)
        log("Child 2 done!")
    }
    log("Parent done!")
}
```

```text
0 [main @coroutine#1] Parent done!
```

- `GlobalScope`ëŠ” ì „ì—­ ìˆ˜ì¤€ì— ì¡´ì¬í•˜ëŠ” ìŠ¤ì½”í”„
- `GlobalScope`ë¥¼ ì‚¬ìš©í•˜ë©´ êµ¬ì¡°í™”ëœ ë™ì‹œì„±ì´ ì œê³µí•˜ëŠ” ëª¨ë“  ì´ì ì„ í¬ê¸°
- ìë™ì·¨ì†Œ ë¶ˆê°€, ìƒëª…ì£¼ê¸° ê°œë… ì—†ìŒ

### ğŸ”– 15.1.4 ì½”ë£¨í‹´ ì½˜í…ìŠ¤íŠ¸ì™€ êµ¬ì¡°í™”ëœ ë™ì‹œì„±

```kotlin
fun main() {
    runBlocking(Dispatchers.Default) {
        log(coroutineContext)
        launch {
            log(coroutineContext)
            launch(Dispatchers.IO + CoroutineName("mine")) {
                log(coroutineContext)
            }
        }
    }
}
```

```text
0 [DefaultDispatcher-worker-1 @coroutine#1] [CoroutineId(1), "coroutine#1":BlockingCoroutine{Active}@3a617b0f, Dispatchers.Default]
13 [DefaultDispatcher-worker-2 @coroutine#2] [CoroutineId(2), "coroutine#2":StandaloneCoroutine{Active}@5e2dba97, Dispatchers.Default]
14 [DefaultDispatcher-worker-3 @mine#3] [CoroutineName(mine), CoroutineId(3), "mine#3":StandaloneCoroutine{Active}@12764f6a, Dispatchers.IO]
```

- ìì‹ ì½”ë£¨í‹´ì€ ë¶€ëª¨ì˜ ì½˜í…ìŠ¤íŠ¸ ìƒì†
- ìƒˆë¡œìš´ ì½”ë£¨í‹´ì€ ë¶€ëª¨-ìì‹ ê´€ê³„ ì„¤ì •í•˜ëŠ” ì—­í• ì„ í•˜ëŠ” ìƒˆ Job ê°ì²´ ìƒì„±
- ë””ìŠ¤íŒ¨ì²˜ë¥¼ ì§€ì •í•˜ì§€ ì•Šê³  ìƒˆë¡œìš´ ì½”ë£¨í‹´ì„ ì‹œì‘í•˜ë©´ ë¶€ëª¨ ì½”ë£¨í‹´ì˜ ë””ìŠ¤íŒ¨ì²˜ì—ì„œ ì‹¤í–‰

```kotlin
fun main() = runBlocking(CoroutineName("A")) {
    log("A's job: ${coroutineContext.job}")
    launch(CoroutineName("B")) {
        log("B's job: ${coroutineContext.job}")
        log("B's parent: ${coroutineContext.job.parent}")
    }
    log("A's children: ${coroutineContext.job.children.toList()}")
}
```

- ì½”ë£¨í‹´ ê°„ì˜ ë¶€ëª¨-ìì‹ ê´€ê³„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ
- êµ¬ì¡°í™”ëœ ë™ì‹œì„±ì— ì˜í•´ ì„¤ì •ëœ ì´ ë¶€ëª¨-ìì‹ ê´€ê³„ëŠ” ì·¨ì†Œì™€ë„ ì—°ê´€ì´ ìˆë‹¤.

## ğŸ“– 15.2 ì·¨ì†Œ

- ì·¨ì†ŒëŠ” ì½”ë“œê°€ ì™„ë£Œë˜ê¸° ì „ì— ì‹¤í–‰ì„ ì¤‘ë‹¨í•˜ëŠ” ê²ƒì„ ì˜ë¯¸
- ì·¨ì†ŒëŠ” ë¶ˆí•„ìš”í•œ ì‘ì—…ì„ ë§‰ì•„ì¤€ë‹¤.
- ì·¨ì†ŒëŠ” ë©”ëª¨ë¦¬ë‚˜ ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ ë°©ì§€ì— ë„ì›€ì„ ì¤€ë‹¤.
- ì·¨ì†ŒëŠ” ì˜¤ë¥˜ ì²˜ë¦¬ì—ì„œë„ ì¤‘ìš”í•œ ì—­í• ì„ í•œë‹¤.

### ğŸ”– 15.2.1 ì·¨ì†Œ ì´‰ë°œ

```kotlin
fun main() = runBlocking {
    val launchedJob = launch {
        log("I'm launched!")
        delay(1000.milliseconds)
        log("I'm done!")
    }
    val asyncDeferred = async {
        log("I'm async")
        delay(1000.milliseconds)
        log("I'm done!")
    }
    delay(200.milliseconds)
    launchedJob.cancel()
    asyncDeferred.cancel()
}
```

```text
0 [main @coroutine#2] I'm launched!
11 [main @coroutine#3] I'm async
```

- `cancel`ì„ í˜¸ì¶œí•´ í•´ë‹¹ ì½”ë£¨í‹´ì˜ ì·¨ì†Œë¥¼ ì´‰ë°œí•  ìˆ˜ ìˆë‹¤.

### ğŸ”– 15.2.2 ì‹œê°„ì œí•œì´ ì´ˆê³¼ëœ í›„ ìë™ìœ¼ë¡œ ì·¨ì†Œ í˜¸ì¶œ

```kotlin
suspend fun calculateSomething(): Int {
    delay(3.seconds)
    return 2 + 2
}

fun main() = runBlocking {
    val quickResult = withTimeoutOrNull(500.milliseconds) {
        calculateSomething()
    }
    println(quickResult) // null
    val slowResult = withTimeoutOrNull(5.seconds) {
        calculateSomething()
    }
    println(slowResult) // 4
}
```

- `withTimeout`, `withTimeoutOrNull` í•¨ìˆ˜ëŠ” ê³„ì‚°ì— ì“¸ ìµœëŒ€ ì‹œê°„ì„ ì œí•œí•˜ë©´ì„œ ê°’ì„ ê³„ì‚°í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

### ğŸ”– 15.2.3 ì·¨ì†ŒëŠ” ëª¨ë“  ìì‹ ì½”ë£¨í‹´ì—ê²Œ ì „íŒŒëœë‹¤

```kotlin
fun main() = runBlocking {
    val job = launch {
        launch {
            launch {
                launch {
                    log("I'm started")
                    delay(500.milliseconds)
                    log("I'm done!")
                }
            }
        }
    }
    delay(200.milliseconds)
    job.cancel()
}
```

- ì½”ë£¨í‹´ì„ ì·¨ì†Œí•˜ë©´ í•´ë‹¹ ì½”ë£¨í‹´ì˜ ëª¨ë“  ìì‹ ì½”ë£¨í‹´ë„ ìë™ìœ¼ë¡œ ì·¨ì†Œëœë‹¤.
- ì—¬ëŸ¬ ê³„ì¸µì— ê±¸ì³ ì½”ë£¨í‹´ì´ ì¤‘ì²©ë¼ ìˆëŠ” ê²½ìš°ì—ë„ ê°€ì¥ ë°”ê¹¥ìª½ ì½”ë£¨í‹´ì„ ì·¨ì†Œí•˜ë©´ ê³ ì†ì ì½”ë£¨í‹´ê¹Œì§€ ëª¨ë‘ ì ì ˆíˆ ì·¨ì†Œëœë‹¤.

### ğŸ”– 15.2.4 ì·¨ì†Œëœ ì½”ë£¨í‹´ì€ íŠ¹ë³„í•œ ì§€ì ì—ì„œ CancellationExceptionì„ ë˜ì§„ë‹¤

- ì·¨ì†Œ ë©”ì»¤ë‹ˆì¦˜ì€ `CancellationException`ì´ë¼ëŠ” íŠ¹ìˆ˜í•œ ì˜ˆì™¸ë¥¼ íŠ¹ë³„í•œ ì§€ì ì—ì„œ ë˜ì§€ëŠ” ë°©ì‹ìœ¼ë¡œ ì‘ë™
- ì·¨ì†Œëœ ì½”ë£¨í‹´ì€ ì¼ì‹œ ì¤‘ë‹¨ ì§€ì ì—ì„œ `CancellationException`ì„ ë˜ì§„ë‹¤.
- ì½”ë£¨í‹´ ê³„ì¸µì—ì„œ ì·¨ì†Œë¥¼ ì „íŒŒí•˜ê¸° ë•Œë¬¸ì— ì´ ì˜ˆì™¸ë¥¼ ì§ì ‘ ì²˜ë¦¬í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.

### ğŸ”– 15.2.5 ì·¨ì†ŒëŠ” í˜‘ë ¥ì ì´ë‹¤

```kotlin
suspend fun doCpuHeavyWork(): Int {
    log("I'm doing work!")
    var counter = 0
    val startTime = System.currentTimeMillis()
    while (System.currentTimeMillis() < startTime + 500) {
        counter++
    }
    return counter
}

fun main() = runBlocking {
    val myJob = launch {
        repeat(5) {
            doCpuHeavyWork()
        }
    }
    delay(600.milliseconds)
    myJob.cancel()
}
```

- í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë˜ê¸° ì „ì— `doCpuHeavyWork`ê°€ 5ë²ˆ ì™„ë£Œëœë‹¤.
- `doCpuHeavyWork` í•¨ìˆ˜ëŠ” ì¼ì‹œ ì¤‘ë‹¨ ì§€ì ì„ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ì½”í‹€ë¦° ì½”ë£¨í‹´ì˜ ì·¨ì†Œê°€ í˜‘ë ¥ì ì¸ ì´ìœ ëŠ” ê²°êµ­ ìŠ¤ìŠ¤ë¡œ ì·¨ì†Œ ê°€ëŠ¥í•˜ê²Œ ë¡œì§ì„ ì œê³µí•´ì•¼ í•˜ê¸° ë•Œë¬¸
  - `delay` í˜¸ì¶œì„ ì¶”ê°€í•˜ë©´ ë¨.

### ğŸ”– 15.2.6 ì½”ë£¨í‹´ì´ ì·¨ì†ŒëëŠ”ì§€ í™•ì¸

```kotlin
val myJob = launch {
    repeat(5) {
        doCpuHeavyWork()
        if (!isActive) return@launch
    }
}
```

- ì½”ë£¨í‹´ì´ ì·¨ì†ŒëëŠ”ì§€ í™•ì¸í•  ë•ŒëŠ” `isActive` ì†ì„±ì„ í™•ì¸
  - `false`ì´ë©´ ë¹„í™œì„±í™”
- `ensureActive` í•¨ìˆ˜ëŠ” ë¹„í™œì„±í™”ì¼ ë•Œ, `CancellationException`ì„ ë˜ì§„ë‹¤.

### ğŸ”– 15.2.7 ë‹¤ë¥¸ ì½”ë£¨í‹´ì—ê²Œ ê¸°íšŒë¥¼ ì£¼ê¸°: yield í•¨ìˆ˜

- ì½”ë£¨í‹´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” `yield` í•¨ìˆ˜ ì œê³µ
  - ì·¨ì†Œ ê°€ëŠ¥ ì§€ì  ì œê³µ
  - ì ìœ ëœ ë””ìŠ¤íŒ¨ì²˜ì—ì„œ ë‹¤ë¥¸ ì½”ë£¨í‹´ì´ ì‘ì—…í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ

```kotlin
fun doCpuHeavyWork(): Int {
    var counter = 0
    val startTime = System.currentTimeMillis()
    while (System.currentTimeMillis() < startTime + 500) {
        counter++
    }
    return counter
}

fun main() {
    runBlocking {
        launch {
            repeat(3) {
                doCpuHeavyWork()
            }
        }
        launch {
            repeat(3) {
                doCpuHeavyWork()
            }
        }
    }
}
```

- ì²« ë²ˆì§¸ ì½”ë£¨í‹´ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ë‘ ë²ˆì§¸ ì½”ë£¨í‹´ì€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ.
- ì¼ì‹œ ì¤‘ë‹¨ ì§€ì ì´ ì—†ê¸° ë•Œë¬¸

```kotlin
suspend fun doCpuHeavyWork(): Int {
    var counter = 0
    val startTime = System.currentTimeMillis()
    while (System.currentTimeMillis() < startTime + 500) {
        counter++
        yield()
    }
    return counter
}

fun main() {
    runBlocking {
        launch {
            repeat(3) {
                doCpuHeavyWork()
            }
        }
        launch {
            repeat(3) {
                doCpuHeavyWork()
            }
        }
    }
}
```

- `yield` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ì½”ë£¨í‹´ì´ êµì°¨ ì‹¤í–‰ë¨

### ğŸ”– 15.2.8 ë¦¬ì†ŒìŠ¤ë¥¼ ì–»ì„ ë•Œ ì·¨ì†Œë¥¼ ì—¼ë‘ì— ë‘ê¸°

- ì·¨ì†Œ í›„, `close` í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì§€ ì•Šê³  ë¦¬ì†ŒìŠ¤ê°€ ëˆ„ìˆ˜ë  ìˆ˜ ìˆìŒ.
- `finally` ë¸”ë¡ì„ ì‚¬ìš©í•´ ëª…ì‹œì ìœ¼ë¡œ ë‹«ì.
- ë¦¬ì†ŒìŠ¤ê°€ `AutoClosable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” ê²½ìš° `.use` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ê°™ì€ ë™ì‘ì„ ë” ê°„ê²°í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

### ğŸ”– 15.2.9 í”„ë ˆì„ì›Œí¬ê°€ ì—¬ëŸ¬ë¶„ ëŒ€ì‹  ì·¨ì†Œë¥¼ í•  ìˆ˜ ìˆë‹¤

- ë§ì€ ì‹¤ì œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” í”„ë ˆì„ì›Œí¬ê°€ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ë¥¼ ì œê³µí•˜ê³  ìë™ì·¨ì†Œí•œë‹¤.
- ì‚¬ìš©ìëŠ” ì ì ˆí•œ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ë¥¼ ì„ íƒ
